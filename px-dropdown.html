<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. ui tests, examples), we assume the server is started with
    'grunt depserve' (or similar server setup) to enable correct finding of bower dependencies for local runs
-->
<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="px-dropdown-content.html" />
<link rel="import" href="px-dropdown-chevron.html" />
<link rel="import" href="px-dropdown-text.html" />
<!--
Element providing a dropdown solution.

##### Usage

<px-dropdown>
  <px-dropdown-text class="px-dropdown-text">Text</px-dropdown-text>
  <px-dropdown-content class="px-dropdown-content" extend-dropdown="true" extend-dropdown-by="15" max-cont-character-width="10" items='[{"key":"one", "val": "One"}, {"key":"two", "val": "Two"}, {"key":"three", "val": "Three"}, {"key":"four", "val": "How now brown cow"}]'>
  </px-dropdown-content>
</px-dropdown>

@element px-dropdown
@blurb Element providing a dropdown solution.
@homepage index.html
@demo demo.html
-->

<dom-module id="px-dropdown">
  <link rel="import" type="css" href="css/px-dropdown.css" />
  <template>
    <div>
      <span
      on-tap="triggerClicked"
      on-mouseover="_hover"
      on-mouseout="_hover"
      class$="{{_dropcellClass(opened, hover)}}"
      id="dropcell">
        <content select=".px-dropdown-text"></content>
        <px-dropdown-chevron class="px-dropdown-chevron"></px-dropdown-chevron>
      </span>
    </div>
    <content select=".px-dropdown-content"></content>
  </template>
</dom-module>
<script>
  Polymer({

    is: 'px-dropdown',
    properties: {
      /*
      * A flag which checks if the dropdown trigger has been clicked or not.
      *
      * @notify true
      * @type Boolean
      * @default false
      */
      opened:{
        type: Boolean,
        notify: true,
        value: false
      },
      /*
      * A flag which reflects whether the dropdown is being hovered over.
      *
      * @notify true
      * @type Boolean
      * @default false
      */
      hover: {
        type: Boolean,
        notify: true,
        value: false
      },
      /*
      * A flag which reflects whether the content is showing above
      * the dropcell.
      * @notify false
      * @type Boolean
      * @default false
      */
      above: {
        type: Boolean,
        value: false
      },
      /*
      * A flag which reflects whether the chevron is hidden
      *
      * @observer _hideChevron
      * @type Boolean
      * @default false
      */
      hideChevron: {
        type: Boolean,
        value: false,
        observer: '_hideChevron'
      },
      _isTextWidthSet: {
        type: Boolean,
        value: false
      }
    },
    attached: function() {
      this.addEventListener('dropdown_flip', this._flipOpened);
      this.addEventListener("resize",  this._reset);
    },
    detached: function() {
      this.removeEventListener('dropdown_flip', this._flipOpened);
      this.removeEventListener("resize", this._reset);
    },
    /* This function is called when the user specifies they would like
    * the chevron to be hidden.
    *
    * @method _hideChevron
    *
    */
    _hideChevron: function() {
      if (this.hideChevron) {
        this.$$('px-dropdown-chevron').style.display = 'none';
      }
    },
   /* This function is called when the dropdown trigger/chevron is clicked, and
   * it either opens or closes (shows/hides) the content.
   *
   * @attribute evt
   * @type Object
   */
    triggerClicked: function(evt) {
      if (!this.opened) {
        Polymer.dom(this).querySelector(".px-dropdown-content").open();
        this._setPosition();
      } else {
        Polymer.dom(this).querySelector(".px-dropdown-content").close();
        this._reset();
      }
      this._flipOpened();
      this._setDivWidth();
      this.fire('dropdownOpen', evt);
    },
    /*
    * This function sets the width of the div inside the px-dropdown-text component.
    * Without doing this,
    *
    * @method _flipOpened
    */
    _setDivWidth: function() {
      if (!this._isWidthSet) {
        var text = Polymer.dom(this).querySelector('px-dropdown-text'),
          div = Polymer.dom(text.root).querySelector('div'),
          dropcell = this.$.dropcell;
        div.style.width = (div.getBoundingClientRect().width - 10) + 'px';
        this.set('_isTextWidthSet', true);
      }
    },
    /*
    * This function flips the "opened" property
    *
    * @method _flipOpened
    */
    _flipOpened: function() {
      this._fireChevron('opened');
      this.opened = !this.opened;
    },
    /*
    * This function flips the "opened" property
    *
    * @method _fireChevron
    */
    _fireChevron: function(fireEvent) {
      var chevron = Polymer.dom(this.root).querySelector('px-dropdown-chevron');
      if (chevron) {
        chevron.fire(fireEvent);
      }
    },
    /*
    * This function returns the correct class for the chevron
    * depending on the state of the component
    * @method _dropcellClass
    * @param opened
    * @param hover
    */
    _dropcellClass: function(opened, hover) {
      var returnClass = 'flex ';
      if (this.opened) {
        returnClass += 'opened';
      } else if (this.hover) {
        returnClass += 'hover';
      }
      return returnClass;
    },
    /*
    * This function fires off a hover event which px-dropdown-chevron
    * picks up, and flips the hover property.
    * @method _hover
    */
    _hover: function() {
      this._fireChevron('hover');
      this.hover = !this.hover;
    },
    /*
    * This function resets the above property as well as set
    * the position property to static and the top property to empty.
    * @method _reset
    */
    _reset: function() {
      var content = Polymer.dom(this).querySelector('px-dropdown-content');
      this.above = false;
      content.style.position = 'relative';
      content.style.top = '';
    },
    /*
    * This function changes the position of the dropdown content
    * if the content area goes under the viewport
    * @method _setPosition
    */
    _setPosition: function() {
      if (this._isoffScreenOnBottom()) {
        this.setTopPosition();
      }
    },
    /*
    * This function figures out whether the content area is
    * under the viewport
    * @method _isoffScreenOnBottom
    */
    _isoffScreenOnBottom: function() {
      var content = Polymer.dom(this).querySelector('px-dropdown-content'),
          dropdown = content.$.dropdown,
          dropdownRect = dropdown.getBoundingClientRect(),
          contentRect = content.getBoundingClientRect(),
          dropdownBottomPoint = dropdownRect.bottom;
      return dropdownBottomPoint > window.innerHeight;
    },
    /*
    * This function changes the position of the content area to be above
    * the dropcell, instead of the default below.
    * @method setTopPosition
    */
    setTopPosition: function() {
      var content = Polymer.dom(this).querySelector('px-dropdown-content'),
          dropdown = content.$.dropdown,
          dropdownRect = dropdown.getClientRects()[0],
          dropcell = this.$.dropcell,
          dropcellRect = dropcell.getClientRects()[0],
          newTop = (parseInt(dropdown.offsetTop) - parseInt(dropdownRect.height) - parseInt(dropcellRect.height)) + 'px';

      dropdown.style.top = newTop;
      this.above = true;
    }
  });
</script>
